<!DOCTYPE html>
<html lang="zh-HK">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Healthcare AI V2 + Live2D Integration Example</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .container {
            display: flex;
            width: 90%;
            max-width: 1200px;
            height: 80vh;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .live2d-panel {
            flex: 1;
            background: linear-gradient(45deg, #f0f8ff, #e6f3ff);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .avatar-container {
            width: 300px;
            height: 400px;
            background: radial-gradient(circle, #ffffff, #f0f8ff);
            border-radius: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 3px solid #e0e8ff;
            margin-bottom: 20px;
        }

        .avatar-placeholder {
            text-align: center;
            color: #6b7db3;
        }

        .avatar-info {
            background: white;
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            width: 100%;
            max-width: 300px;
        }

        .agent-name {
            font-size: 18px;
            font-weight: bold;
            color: #333;
            margin-bottom: 5px;
        }

        .agent-emotion {
            font-size: 14px;
            color: #666;
            margin-bottom: 5px;
        }

        .agent-gesture {
            font-size: 12px;
            color: #888;
        }

        .chat-panel {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: #fafafa;
        }

        .chat-header {
            background: #4a90e2;
            color: white;
            padding: 20px;
            text-align: center;
        }

        .chat-header h1 {
            margin-bottom: 5px;
        }

        .connection-status {
            font-size: 14px;
            opacity: 0.9;
        }

        .connection-status.connected {
            color: #4caf50;
        }

        .connection-status.disconnected {
            color: #f44336;
        }

        .chat-messages {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            background: white;
        }

        .message {
            margin-bottom: 15px;
            padding: 10px 15px;
            border-radius: 15px;
            max-width: 80%;
            word-wrap: break-word;
        }

        .message.user {
            background: #4a90e2;
            color: white;
            margin-left: auto;
            border-bottom-right-radius: 5px;
        }

        .message.agent {
            background: #f0f0f0;
            color: #333;
            border-bottom-left-radius: 5px;
        }

        .message.system {
            background: #fff3cd;
            color: #856404;
            text-align: center;
            font-size: 14px;
            border-radius: 20px;
        }

        .message.emergency {
            background: #f8d7da;
            color: #721c24;
            border: 2px solid #f5c6cb;
            animation: pulse 1s infinite;
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.02); }
            100% { transform: scale(1); }
        }

        .message-meta {
            font-size: 12px;
            opacity: 0.7;
            margin-top: 5px;
        }

        .typing-indicator {
            display: none;
            background: #f0f0f0;
            color: #666;
            padding: 10px 15px;
            border-radius: 15px;
            margin-bottom: 15px;
            font-style: italic;
        }

        .typing-indicator.show {
            display: block;
        }

        .chat-input {
            padding: 20px;
            background: #f8f9fa;
            border-top: 1px solid #dee2e6;
        }

        .input-group {
            display: flex;
            gap: 10px;
        }

        .chat-input input {
            flex: 1;
            padding: 12px 15px;
            border: 2px solid #ddd;
            border-radius: 25px;
            font-size: 16px;
            outline: none;
            transition: border-color 0.3s;
        }

        .chat-input input:focus {
            border-color: #4a90e2;
        }

        .chat-input button {
            padding: 12px 20px;
            background: #4a90e2;
            color: white;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            font-size: 16px;
            transition: background 0.3s;
        }

        .chat-input button:hover {
            background: #357abd;
        }

        .chat-input button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        .facilities-panel {
            position: fixed;
            right: 20px;
            top: 50%;
            transform: translateY(-50%);
            width: 300px;
            max-height: 60vh;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            overflow: hidden;
            display: none;
        }

        .facilities-panel.show {
            display: block;
        }

        .facilities-header {
            background: #28a745;
            color: white;
            padding: 15px;
            text-align: center;
            font-weight: bold;
        }

        .facilities-list {
            max-height: 400px;
            overflow-y: auto;
        }

        .facility-card {
            padding: 15px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
            transition: background 0.3s;
        }

        .facility-card:hover {
            background: #f8f9fa;
        }

        .facility-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 8px;
        }

        .facility-icon {
            font-size: 20px;
        }

        .facility-name {
            flex: 1;
            font-weight: bold;
            font-size: 14px;
        }

        .urgency-indicator {
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 12px;
            font-weight: bold;
        }

        .urgency-low {
            background: #d4edda;
            color: #155724;
        }

        .urgency-medium {
            background: #fff3cd;
            color: #856404;
        }

        .urgency-high {
            background: #f8d7da;
            color: #721c24;
        }

        .facility-details {
            font-size: 12px;
            color: #666;
            line-height: 1.4;
        }

        .emergency-alert-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .emergency-alert {
            background: white;
            padding: 30px;
            border-radius: 15px;
            max-width: 500px;
            text-align: center;
            box-shadow: 0 20px 40px rgba(0,0,0,0.3);
        }

        .alert-header {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            margin-bottom: 20px;
        }

        .alert-icon {
            font-size: 30px;
            animation: blink 1s infinite;
        }

        @keyframes blink {
            0%, 50% { opacity: 1; }
            51%, 100% { opacity: 0.3; }
        }

        .alert-header h2 {
            color: #dc3545;
            margin: 0;
        }

        .alert-message {
            font-size: 18px;
            margin-bottom: 20px;
            color: #333;
        }

        .emergency-button {
            background: #dc3545;
            color: white;
            padding: 15px 30px;
            border: none;
            border-radius: 10px;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            margin: 10px;
            transition: background 0.3s;
        }

        .emergency-button:hover {
            background: #c82333;
        }

        .close-alert {
            background: #6c757d;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin-top: 20px;
        }

        .controls {
            position: fixed;
            bottom: 20px;
            left: 20px;
            display: flex;
            gap: 10px;
        }

        .control-button {
            padding: 10px 15px;
            background: #6c757d;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
        }

        .control-button:hover {
            background: #5a6268;
        }

        .stats {
            position: fixed;
            top: 20px;
            left: 20px;
            background: rgba(255,255,255,0.9);
            padding: 10px;
            border-radius: 5px;
            font-size: 12px;
            font-family: monospace;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Live2D Avatar Panel -->
        <div class="live2d-panel">
            <div class="avatar-container">
                <div class="avatar-placeholder">
                    <div style="font-size: 48px; margin-bottom: 10px;">🤖</div>
                    <div>Live2D Avatar</div>
                    <div style="font-size: 12px; margin-top: 5px;">Ready for Healthcare AI</div>
                </div>
            </div>
            
            <div class="avatar-info">
                <div class="agent-name" id="agentName">Healthcare Assistant</div>
                <div class="agent-emotion" id="agentEmotion">Emotion: neutral</div>
                <div class="agent-gesture" id="agentGesture">Gesture: default</div>
            </div>
        </div>

        <!-- Chat Panel -->
        <div class="chat-panel">
            <div class="chat-header">
                <h1>Healthcare AI V2</h1>
                <div class="connection-status" id="connectionStatus">Connecting...</div>
            </div>

            <div class="chat-messages" id="chatMessages">
                <div class="message system">
                    歡迎使用 Healthcare AI V2 + Live2D 系統<br>
                    Welcome to Healthcare AI V2 + Live2D System
                </div>
            </div>

            <div class="typing-indicator" id="typingIndicator">
                AI is thinking...
            </div>

            <div class="chat-input">
                <form class="input-group" id="chatForm">
                    <input 
                        type="text" 
                        id="chatInput" 
                        placeholder="輸入您的健康問題... / Enter your health question..."
                        autocomplete="off"
                    >
                    <button type="submit" id="sendButton">Send</button>
                </form>
            </div>
        </div>
    </div>

    <!-- HK Facilities Panel -->
    <div class="facilities-panel" id="facilitiesPanel">
        <div class="facilities-header">
            香港醫療設施 / HK Medical Facilities
        </div>
        <div class="facilities-list" id="facilitiesList">
            <!-- Facilities will be populated here -->
        </div>
    </div>

    <!-- Controls -->
    <div class="controls">
        <button class="control-button" onclick="toggleFacilities()">Toggle Facilities</button>
        <button class="control-button" onclick="toggleStats()">Toggle Stats</button>
        <button class="control-button" onclick="testEmergency()">Test Emergency</button>
    </div>

    <!-- Stats -->
    <div class="stats" id="stats" style="display: none;">
        <div>Status: <span id="statsStatus">-</span></div>
        <div>Messages: <span id="statsMessages">-</span></div>
        <div>Avg Response: <span id="statsResponse">-</span></div>
        <div>Agent: <span id="statsAgent">-</span></div>
        <div>Emotion: <span id="statsEmotion">-</span></div>
        <div>Gesture: <span id="statsGesture">-</span></div>
    </div>

    <!-- Include the Live2D client -->
    <script src="live2d_frontend_integration.js"></script>

    <script>
        // Initialize Healthcare AI Live2D Client
        const client = new HealthcareAILive2DClient({
            wsUrl: 'ws://localhost:8000/ws/live2d/chat',
            apiUrl: 'http://localhost:8000/api/v1',
            language: 'zh-HK',
            clientType: 'live2d'
        });

        // DOM elements
        const chatMessages = document.getElementById('chatMessages');
        const chatInput = document.getElementById('chatInput');
        const sendButton = document.getElementById('sendButton');
        const connectionStatus = document.getElementById('connectionStatus');
        const typingIndicator = document.getElementById('typingIndicator');
        const agentName = document.getElementById('agentName');
        const agentEmotion = document.getElementById('agentEmotion');
        const agentGesture = document.getElementById('agentGesture');
        const facilitiesPanel = document.getElementById('facilitiesPanel');
        const facilitiesList = document.getElementById('facilitiesList');

        // Event handlers
        client.on('connected', () => {
            connectionStatus.textContent = 'Connected';
            connectionStatus.className = 'connection-status connected';
            sendButton.disabled = false;
            addSystemMessage('✅ Connected to Healthcare AI');
        });

        client.on('disconnected', () => {
            connectionStatus.textContent = 'Disconnected';
            connectionStatus.className = 'connection-status disconnected';
            sendButton.disabled = true;
            addSystemMessage('❌ Disconnected from Healthcare AI');
        });

        client.on('agentResponse', (data) => {
            hideTypingIndicator();
            addAgentMessage(data.message, data);
            
            // Update avatar info
            agentName.textContent = data.agentName;
            agentEmotion.textContent = `Emotion: ${data.emotion}`;
            agentGesture.textContent = `Gesture: ${data.gesture}`;
            
            // Show facilities if available
            if (data.hkFacilities && data.hkFacilities.length > 0) {
                displayFacilities(data.hkFacilities);
            }
            
            // Speak the response
            speakText(data.message, data.language);
        });

        client.on('emotionChange', (data) => {
            agentEmotion.textContent = `Emotion: ${data.newEmotion}`;
            console.log(`😊 Emotion changed: ${data.newEmotion}`);
        });

        client.on('gestureChange', (data) => {
            agentGesture.textContent = `Gesture: ${data.newGesture}`;
            console.log(`👋 Gesture changed: ${data.newGesture}`);
        });

        client.on('emergencyAlert', (data) => {
            showEmergencyAlert(data);
        });

        client.on('error', (data) => {
            console.error('Client error:', data);
            addSystemMessage(`❌ Error: ${data.message || 'Unknown error'}`);
        });

        // Chat functions
        function addUserMessage(text) {
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message user';
            messageDiv.innerHTML = `
                ${escapeHtml(text)}
                <div class="message-meta">${new Date().toLocaleTimeString()}</div>
            `;
            chatMessages.appendChild(messageDiv);
            scrollToBottom();
        }

        function addAgentMessage(text, data = {}) {
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message agent';
            
            let urgencyClass = '';
            if (data.urgency === 'emergency' || data.urgency === 'high') {
                urgencyClass = ' emergency';
            }
            
            messageDiv.className += urgencyClass;
            messageDiv.innerHTML = `
                ${escapeHtml(text)}
                <div class="message-meta">
                    ${data.agentName || 'AI'} • ${data.emotion || 'neutral'} • ${data.confidence ? Math.round(data.confidence * 100) + '%' : ''} • ${new Date().toLocaleTimeString()}
                </div>
            `;
            chatMessages.appendChild(messageDiv);
            scrollToBottom();
        }

        function addSystemMessage(text) {
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message system';
            messageDiv.innerHTML = `
                ${escapeHtml(text)}
                <div class="message-meta">${new Date().toLocaleTimeString()}</div>
            `;
            chatMessages.appendChild(messageDiv);
            scrollToBottom();
        }

        function showTypingIndicator() {
            typingIndicator.className = 'typing-indicator show';
            scrollToBottom();
        }

        function hideTypingIndicator() {
            typingIndicator.className = 'typing-indicator';
        }

        function scrollToBottom() {
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Send message
        function sendMessage() {
            const text = chatInput.value.trim();
            if (!text) return;

            addUserMessage(text);
            showTypingIndicator();
            client.sendMessage(text);
            chatInput.value = '';
        }

        // Typing indicators
        let typingTimer;
        chatInput.addEventListener('input', () => {
            client.sendTypingStart();
            
            clearTimeout(typingTimer);
            typingTimer = setTimeout(() => {
                client.sendTypingStop();
            }, 1000);
        });

        // Form submission
        document.getElementById('chatForm').addEventListener('submit', (e) => {
            e.preventDefault();
            sendMessage();
        });

        // Voice synthesis
        function speakText(text, language = 'zh-HK') {
            if ('speechSynthesis' in window) {
                const utterance = new SpeechSynthesisUtterance(text);
                utterance.lang = language === 'zh-HK' ? 'zh-HK' : 'en-US';
                utterance.rate = 0.9;
                utterance.pitch = 1.0;
                speechSynthesis.speak(utterance);
            }
        }

        // Facilities display
        function displayFacilities(facilities) {
            facilitiesList.innerHTML = facilities.map(facility => `
                <div class="facility-card" onclick="selectFacility('${facility.id}')">
                    <div class="facility-header">
                        <span class="facility-icon">${facility.live2d_display?.icon || '🏥'}</span>
                        <span class="facility-name">${facility.name_zh || facility.name_en}</span>
                        <span class="urgency-indicator urgency-${facility.live2d_display?.urgency_indicator || 'low'}">
                            ${facility.waiting_time || 'N/A'}
                        </span>
                    </div>
                    <div class="facility-details">
                        ${facility.address || ''}<br>
                        ${facility.phone || ''}
                    </div>
                </div>
            `).join('');
            
            facilitiesPanel.className = 'facilities-panel show';
        }

        function selectFacility(facilityId) {
            console.log('Selected facility:', facilityId);
            // Add facility selection logic here
        }

        // Emergency alert
        function showEmergencyAlert(alertData) {
            const alertOverlay = document.createElement('div');
            alertOverlay.className = 'emergency-alert-overlay';
            alertOverlay.innerHTML = `
                <div class="emergency-alert">
                    <div class="alert-header">
                        <span class="alert-icon">🚨</span>
                        <h2>緊急警示 / Emergency Alert</h2>
                    </div>
                    <div class="alert-content">
                        <p class="alert-message">${alertData.message}</p>
                        <div class="emergency-contacts">
                            <button onclick="window.open('tel:999')" class="emergency-button">
                                📞 致電 999 / Call 999
                            </button>
                        </div>
                    </div>
                    <button onclick="this.parentElement.parentElement.remove()" class="close-alert">關閉 / Close</button>
                </div>
            `;
            
            document.body.appendChild(alertOverlay);
        }

        // Control functions
        function toggleFacilities() {
            const panel = document.getElementById('facilitiesPanel');
            panel.style.display = panel.style.display === 'none' ? 'block' : 'none';
        }

        function toggleStats() {
            const stats = document.getElementById('stats');
            stats.style.display = stats.style.display === 'none' ? 'block' : 'none';
            
            if (stats.style.display === 'block') {
                updateStats();
                setInterval(updateStats, 2000);
            }
        }

        function updateStats() {
            const stats = client.getStats();
            document.getElementById('statsStatus').textContent = stats.isConnected ? 'Connected' : 'Disconnected';
            document.getElementById('statsMessages').textContent = stats.messageCount;
            document.getElementById('statsResponse').textContent = stats.averageResponseTime + 'ms';
            document.getElementById('statsAgent').textContent = stats.currentAgent || 'None';
            document.getElementById('statsEmotion').textContent = stats.currentEmotion;
            document.getElementById('statsGesture').textContent = stats.currentGesture;
        }

        function testEmergency() {
            client.sendMessage('我胸口好痛，唔可以呼吸！');
        }

        // Initialize
        sendButton.disabled = true;
        
        // Add some example messages on load
        setTimeout(() => {
            addSystemMessage('🏥 Healthcare AI V2 with Live2D integration ready');
            addSystemMessage('💬 Try: "我頭痛" or "I have a headache"');
            addSystemMessage('🚨 Test emergency: "我胸口痛"');
        }, 1000);
    </script>
</body>
</html>
