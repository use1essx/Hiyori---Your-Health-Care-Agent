{% extends "base.html" %}

{% block title %}Document Management - Healthcare AI V2{% endblock %}
{% block page_title %}Document Management{% endblock %}

{% block extra_head %}
<meta name="csrf-token" content="{{ csrf_token() }}">
{% endblock %}

{% block content %}
<div class="space-y-6">
    <!-- Header with Actions -->
    <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center space-y-4 sm:space-y-0">
        <div>
            <h1 class="text-2xl font-bold text-gray-900">Document Management</h1>
            <p class="text-gray-600 mt-1">Upload, review, and manage medical documents</p>
        </div>
        
        <div class="flex space-x-3">
            <button onclick="openUploadModal()" class="btn-primary flex items-center">
                <i class="fas fa-plus mr-2"></i>
                Upload Document
            </button>
            
            <button onclick="exportDocuments()" class="bg-gray-600 text-white px-4 py-2 rounded-lg hover:bg-gray-700 flex items-center">
                <i class="fas fa-download mr-2"></i>
                Export
            </button>
        </div>
    </div>
    
    <!-- Statistics Cards -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
        <div class="bg-white rounded-lg p-6 card-shadow">
            <div class="flex items-center">
                <div class="p-3 rounded-full bg-blue-100 text-blue-600">
                    <i class="fas fa-file-medical text-xl"></i>
                </div>
                <div class="ml-4">
                    <h3 class="text-2xl font-bold text-gray-900" id="total-documents">{{ stats.total_documents or 0 }}</h3>
                    <p class="text-gray-600">Total Documents</p>
                </div>
            </div>
        </div>
        
        <div class="bg-white rounded-lg p-6 card-shadow">
            <div class="flex items-center">
                <div class="p-3 rounded-full bg-yellow-100 text-yellow-600">
                    <i class="fas fa-clock text-xl"></i>
                </div>
                <div class="ml-4">
                    <h3 class="text-2xl font-bold text-gray-900" id="pending-review">{{ stats.pending_approval or 0 }}</h3>
                    <p class="text-gray-600">Pending Review</p>
                </div>
            </div>
        </div>
        
        <div class="bg-white rounded-lg p-6 card-shadow">
            <div class="flex items-center">
                <div class="p-3 rounded-full bg-green-100 text-green-600">
                    <i class="fas fa-check-circle text-xl"></i>
                </div>
                <div class="ml-4">
                    <h3 class="text-2xl font-bold text-gray-900" id="approved-documents">{{ stats.approved_documents or 0 }}</h3>
                    <p class="text-gray-600">Approved</p>
                </div>
            </div>
        </div>
        
        <div class="bg-white rounded-lg p-6 card-shadow">
            <div class="flex items-center">
                <div class="p-3 rounded-full bg-purple-100 text-purple-600">
                    <i class="fas fa-chart-line text-xl"></i>
                </div>
                <div class="ml-4">
                    <h3 class="text-2xl font-bold text-gray-900" id="avg-quality">{{ "%.1f"|format(stats.average_quality_score or 0) }}</h3>
                    <p class="text-gray-600">Avg Quality</p>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Search and Filters -->
    <div class="bg-white rounded-lg p-6 card-shadow">
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Search</label>
                <div class="relative">
                    <input type="text" id="search-input" placeholder="Search documents..." 
                           class="w-full pl-10 pr-3 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                    <i class="fas fa-search absolute left-3 top-3 text-gray-400"></i>
                </div>
            </div>
            
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Category</label>
                <select id="category-filter" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                    <option value="">All Categories</option>
                    <option value="medical_guidelines">Medical Guidelines</option>
                    <option value="treatment_protocols">Treatment Protocols</option>
                    <option value="medication_info">Medication Info</option>
                    <option value="emergency_procedures">Emergency Procedures</option>
                    <option value="hk_health_policies">HK Health Policies</option>
                    <option value="clinical_research">Clinical Research</option>
                    <option value="patient_education">Patient Education</option>
                    <option value="administrative_forms">Administrative Forms</option>
                </select>
            </div>
            
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Status</label>
                <select id="status-filter" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                    <option value="">All Status</option>
                    <option value="processing">Processing</option>
                    <option value="pending_approval">Pending Review</option>
                    <option value="approved">Approved</option>
                    <option value="rejected">Rejected</option>
                    <option value="needs_revision">Needs Revision</option>
                </select>
            </div>
            
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Actions</label>
                <div class="flex space-x-2">
                    <button onclick="applyFilters()" class="flex-1 bg-blue-600 text-white px-3 py-2 rounded-lg hover:bg-blue-700">
                        <i class="fas fa-filter mr-1"></i> Filter
                    </button>
                    <button onclick="clearFilters()" class="bg-gray-300 text-gray-700 px-3 py-2 rounded-lg hover:bg-gray-400">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Documents Table -->
    <div class="bg-white rounded-lg card-shadow overflow-hidden">
        <div class="px-6 py-4 border-b border-gray-200">
            <div class="flex items-center justify-between">
                <h3 class="text-lg font-semibold text-gray-900">Documents</h3>
                <div class="flex items-center space-x-2">
                    <span class="text-sm text-gray-500" id="results-count">Loading...</span>
                    <div class="flex items-center space-x-1">
                        <button onclick="previousPage()" id="prev-btn" class="p-1 rounded text-gray-400 hover:text-gray-600 disabled:opacity-50" disabled>
                            <i class="fas fa-chevron-left"></i>
                        </button>
                        <span class="text-sm text-gray-500" id="page-info">Page 1 of 1</span>
                        <button onclick="nextPage()" id="next-btn" class="p-1 rounded text-gray-400 hover:text-gray-600 disabled:opacity-50" disabled>
                            <i class="fas fa-chevron-right"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="overflow-x-auto">
            <table class="w-full" id="documents-table">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                            <input type="checkbox" id="select-all" onchange="toggleSelectAll()">
                        </th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Document</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Category</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Quality Score</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Uploaded</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                    </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200" id="documents-tbody">
                    <!-- Documents will be loaded here via JavaScript -->
                </tbody>
            </table>
        </div>
        
        <div id="loading-table" class="text-center py-8">
            <div class="inline-flex items-center">
                <div class="animate-spin rounded-full h-6 w-6 border-b-2 border-blue-600 mr-3"></div>
                <span class="text-gray-600">Loading documents...</span>
            </div>
        </div>
        
        <div id="no-documents" class="text-center py-8 hidden">
            <i class="fas fa-file-medical text-4xl text-gray-300 mb-4"></i>
            <h3 class="text-lg font-medium text-gray-900 mb-2">No documents found</h3>
            <p class="text-gray-600 mb-4">Try adjusting your search criteria or upload a new document.</p>
            <button onclick="openUploadModal()" class="btn-primary">
                <i class="fas fa-plus mr-2"></i>
                Upload Document
            </button>
        </div>
    </div>
    
    <!-- Bulk Actions -->
    <div class="bg-white rounded-lg p-4 card-shadow hidden" id="bulk-actions">
        <div class="flex items-center justify-between">
            <span class="text-sm text-gray-600" id="selected-count">0 documents selected</span>
            <div class="flex space-x-2">
                <button onclick="bulkApprove()" class="btn-secondary text-sm">
                    <i class="fas fa-check mr-1"></i> Approve Selected
                </button>
                <button onclick="bulkReject()" class="bg-red-600 text-white px-3 py-1 rounded text-sm hover:bg-red-700">
                    <i class="fas fa-times mr-1"></i> Reject Selected
                </button>
                <button onclick="bulkDelete()" class="bg-gray-600 text-white px-3 py-1 rounded text-sm hover:bg-gray-700">
                    <i class="fas fa-trash mr-1"></i> Delete Selected
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Upload Modal -->
<div class="modal-overlay hidden" id="upload-modal">
    <div class="modal-content max-w-2xl">
        <div class="flex items-center justify-between mb-6">
            <h2 class="text-xl font-bold text-gray-900">Upload Document</h2>
            <button onclick="closeUploadModal()" class="text-gray-400 hover:text-gray-600">
                <i class="fas fa-times text-xl"></i>
            </button>
        </div>
        
        <form id="upload-form" enctype="multipart/form-data">
            <div class="space-y-4">
                <!-- File Upload Zone -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Document File</label>
                    <div class="upload-zone" id="upload-zone" onclick="document.getElementById('file-input').click()">
                        <input type="file" id="file-input" name="file" accept=".pdf,.jpg,.jpeg,.png,.txt,.doc,.docx" class="hidden" onchange="handleFileSelect(event)">
                        <i class="fas fa-cloud-upload-alt text-4xl text-gray-400 mb-4"></i>
                        <p class="text-lg text-gray-600 mb-2">Drop files here or click to browse</p>
                        <p class="text-sm text-gray-500">Supports PDF, images (JPG, PNG), and text files up to 50MB</p>
                    </div>
                    <div id="file-preview" class="hidden mt-4 p-4 bg-gray-50 rounded-lg">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center">
                                <i class="fas fa-file text-blue-600 mr-3"></i>
                                <div>
                                    <p class="font-medium text-gray-900" id="file-name"></p>
                                    <p class="text-sm text-gray-500" id="file-size"></p>
                                </div>
                            </div>
                            <button type="button" onclick="clearFileSelection()" class="text-red-600 hover:text-red-800">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- Document Metadata -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Category *</label>
                        <select name="category" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                            <option value="">Select Category</option>
                            <option value="medical_guidelines">Medical Guidelines</option>
                            <option value="treatment_protocols">Treatment Protocols</option>
                            <option value="medication_info">Medication Info</option>
                            <option value="emergency_procedures">Emergency Procedures</option>
                            <option value="hk_health_policies">HK Health Policies</option>
                            <option value="clinical_research">Clinical Research</option>
                            <option value="patient_education">Patient Education</option>
                            <option value="administrative_forms">Administrative Forms</option>
                        </select>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Language</label>
                        <select name="language" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                            <option value="en">English</option>
                            <option value="zh-HK">Traditional Chinese (HK)</option>
                            <option value="zh-CN">Simplified Chinese</option>
                        </select>
                    </div>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Title</label>
                    <input type="text" name="title" placeholder="Document title (optional)" 
                           class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Description</label>
                    <textarea name="description" rows="3" placeholder="Document description (optional)" 
                              class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500"></textarea>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Tags</label>
                    <input type="text" name="tags" placeholder="Comma-separated tags (optional)" 
                           class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                    <p class="text-xs text-gray-500 mt-1">e.g., cardiology, treatment, guidelines</p>
                </div>
                
                <div class="flex items-center">
                    <input type="checkbox" name="is_sensitive" id="is_sensitive" class="mr-2">
                    <label for="is_sensitive" class="text-sm text-gray-700">This document contains sensitive or confidential information</label>
                </div>
            </div>
            
            <!-- Upload Progress -->
            <div id="upload-progress" class="hidden mt-6">
                <div class="flex items-center justify-between mb-2">
                    <span class="text-sm text-gray-600">Uploading...</span>
                    <span class="text-sm text-gray-600" id="upload-percentage">0%</span>
                </div>
                <div class="progress-bar">
                    <div class="progress-fill" id="upload-progress-fill" style="width: 0%"></div>
                </div>
            </div>
            
            <!-- Form Actions -->
            <div class="flex justify-end space-x-3 mt-6">
                <button type="button" onclick="closeUploadModal()" class="px-4 py-2 text-gray-700 bg-gray-200 rounded-lg hover:bg-gray-300">
                    Cancel
                </button>
                <button type="submit" class="btn-primary" id="upload-btn">
                    <i class="fas fa-cloud-upload-alt mr-2"></i>
                    Upload Document
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Document Detail Modal -->
<div class="modal-overlay hidden" id="detail-modal">
    <div class="modal-content max-w-4xl">
        <div class="flex items-center justify-between mb-6">
            <h2 class="text-xl font-bold text-gray-900">Document Details</h2>
            <button onclick="closeDetailModal()" class="text-gray-400 hover:text-gray-600">
                <i class="fas fa-times text-xl"></i>
            </button>
        </div>
        
        <div id="document-details">
            <!-- Document details will be loaded here -->
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
    let currentPage = 1;
    let totalPages = 1;
    let selectedDocuments = new Set();
    
    // Initialize page
    document.addEventListener('DOMContentLoaded', function() {
        loadDocuments();
        setupEventListeners();
    });
    
    function setupEventListeners() {
        // Search input
        const searchInput = document.getElementById('search-input');
        let searchTimeout;
        searchInput.addEventListener('input', function() {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(() => {
                currentPage = 1;
                loadDocuments();
            }, 500);
        });
        
        // File upload drag and drop
        const uploadZone = document.getElementById('upload-zone');
        
        uploadZone.addEventListener('dragover', function(e) {
            e.preventDefault();
            uploadZone.classList.add('drag-over');
        });
        
        uploadZone.addEventListener('dragleave', function(e) {
            e.preventDefault();
            uploadZone.classList.remove('drag-over');
        });
        
        uploadZone.addEventListener('drop', function(e) {
            e.preventDefault();
            uploadZone.classList.remove('drag-over');
            
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                document.getElementById('file-input').files = files;
                handleFileSelect({ target: { files: files } });
            }
        });
        
        // Upload form submission
        document.getElementById('upload-form').addEventListener('submit', handleUpload);
    }
    
    async function loadDocuments() {
        const tbody = document.getElementById('documents-tbody');
        const loadingIndicator = document.getElementById('loading-table');
        const noDocuments = document.getElementById('no-documents');
        
        // Show loading
        tbody.innerHTML = '';
        loadingIndicator.classList.remove('hidden');
        noDocuments.classList.add('hidden');
        
        try {
            const params = new URLSearchParams({
                page: currentPage,
                limit: 20
            });
            
            // Add filters
            const search = document.getElementById('search-input').value;
            const category = document.getElementById('category-filter').value;
            const status = document.getElementById('status-filter').value;
            
            if (search) params.append('query', search);
            if (category) params.append('category', category);
            if (status) params.append('status', status);
            
            const response = await apiCall(`/api/v1/uploads/documents?${params}`);
            
            // Hide loading
            loadingIndicator.classList.add('hidden');
            
            if (response.documents && response.documents.length > 0) {
                renderDocuments(response.documents);
                updatePagination(response.pagination);
                updateResultsCount(response.pagination);
            } else {
                noDocuments.classList.remove('hidden');
            }
            
        } catch (error) {
            loadingIndicator.classList.add('hidden');
            showError('Failed to load documents: ' + error.message);
        }
    }
    
    function renderDocuments(documents) {
        const tbody = document.getElementById('documents-tbody');
        
        tbody.innerHTML = documents.map(doc => `
            <tr class="hover:bg-gray-50">
                <td class="px-6 py-4 whitespace-nowrap">
                    <input type="checkbox" value="${doc.id}" onchange="toggleDocumentSelection(${doc.id}, this.checked)">
                </td>
                <td class="px-6 py-4">
                    <div class="flex items-center">
                        <div class="flex-shrink-0 h-10 w-10">
                            <div class="h-10 w-10 rounded-lg bg-blue-100 flex items-center justify-center">
                                <i class="fas fa-${getFileIcon(doc.file_type)} text-blue-600"></i>
                            </div>
                        </div>
                        <div class="ml-4">
                            <div class="text-sm font-medium text-gray-900">${escapeHtml(doc.title)}</div>
                            <div class="text-sm text-gray-500">${doc.original_filename}</div>
                            <div class="text-xs text-gray-400">${formatFileSize(doc.file_size)}</div>
                        </div>
                    </div>
                </td>
                <td class="px-6 py-4 whitespace-nowrap">
                    <span class="px-2 py-1 text-xs font-medium bg-gray-100 text-gray-800 rounded-full">
                        ${formatCategory(doc.category)}
                    </span>
                </td>
                <td class="px-6 py-4 whitespace-nowrap">
                    ${doc.quality_score ? `
                        <div class="quality-score" data-score="${doc.quality_score}">
                            <span class="text-sm font-medium text-gray-900">${(doc.quality_score * 100).toFixed(0)}%</span>
                            <div class="quality-bar">
                                <div class="quality-fill"></div>
                            </div>
                        </div>
                    ` : '<span class="text-gray-400">â€”</span>'}
                </td>
                <td class="px-6 py-4 whitespace-nowrap">
                    <span class="status-badge status-${doc.status}">
                        ${formatStatus(doc.status)}
                    </span>
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                    <div>${formatDate(doc.created_at)}</div>
                    ${doc.uploaded_by ? `<div class="text-xs">by ${escapeHtml(doc.uploaded_by.username)}</div>` : ''}
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                    <div class="flex space-x-2">
                        <button onclick="viewDocument(${doc.id})" class="text-blue-600 hover:text-blue-900" title="View Details">
                            <i class="fas fa-eye"></i>
                        </button>
                        ${doc.status === 'pending_approval' ? `
                            <button onclick="approveDocument(${doc.id})" class="text-green-600 hover:text-green-900" title="Approve">
                                <i class="fas fa-check"></i>
                            </button>
                            <button onclick="rejectDocument(${doc.id})" class="text-red-600 hover:text-red-900" title="Reject">
                                <i class="fas fa-times"></i>
                            </button>
                        ` : ''}
                        <button onclick="deleteDocument(${doc.id})" class="text-red-600 hover:text-red-900" title="Delete">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </td>
            </tr>
        `).join('');
        
        // Initialize quality bars
        document.querySelectorAll('.quality-score').forEach(element => {
            const score = parseFloat(element.dataset.score);
            updateQualityBar(element, score);
        });
    }
    
    function getFileIcon(fileType) {
        const icons = {
            'pdf': 'file-pdf',
            'jpg': 'file-image',
            'jpeg': 'file-image',
            'png': 'file-image',
            'txt': 'file-alt',
            'doc': 'file-word',
            'docx': 'file-word'
        };
        return icons[fileType] || 'file';
    }
    
    function formatCategory(category) {
        return category.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
    }
    
    function formatStatus(status) {
        const statusMap = {
            'processing': 'Processing',
            'pending_approval': 'Pending Review',
            'approved': 'Approved',
            'rejected': 'Rejected',
            'needs_revision': 'Needs Revision'
        };
        return statusMap[status] || status;
    }
    
    function formatDate(dateString) {
        return new Date(dateString).toLocaleDateString();
    }
    
    function formatFileSize(bytes) {
        if (bytes === 0) return '0 Bytes';
        const k = 1024;
        const sizes = ['Bytes', 'KB', 'MB', 'GB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
    }
    
    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }
    
    function updatePagination(pagination) {
        totalPages = pagination.pages;
        document.getElementById('page-info').textContent = `Page ${pagination.page} of ${pagination.pages}`;
        
        const prevBtn = document.getElementById('prev-btn');
        const nextBtn = document.getElementById('next-btn');
        
        prevBtn.disabled = pagination.page <= 1;
        nextBtn.disabled = pagination.page >= pagination.pages;
    }
    
    function updateResultsCount(pagination) {
        const start = ((pagination.page - 1) * pagination.limit) + 1;
        const end = Math.min(pagination.page * pagination.limit, pagination.total);
        document.getElementById('results-count').textContent = 
            `Showing ${start}-${end} of ${pagination.total} documents`;
    }
    
    function previousPage() {
        if (currentPage > 1) {
            currentPage--;
            loadDocuments();
        }
    }
    
    function nextPage() {
        if (currentPage < totalPages) {
            currentPage++;
            loadDocuments();
        }
    }
    
    function applyFilters() {
        currentPage = 1;
        loadDocuments();
    }
    
    function clearFilters() {
        document.getElementById('search-input').value = '';
        document.getElementById('category-filter').value = '';
        document.getElementById('status-filter').value = '';
        currentPage = 1;
        loadDocuments();
    }
    
    // Upload Modal Functions
    function openUploadModal() {
        document.getElementById('upload-modal').classList.remove('hidden');
        document.body.style.overflow = 'hidden';
    }
    
    function closeUploadModal() {
        document.getElementById('upload-modal').classList.add('hidden');
        document.body.style.overflow = '';
        document.getElementById('upload-form').reset();
        clearFileSelection();
    }
    
    function handleFileSelect(event) {
        const file = event.target.files[0];
        if (!file) return;
        
        const filePreview = document.getElementById('file-preview');
        const fileName = document.getElementById('file-name');
        const fileSize = document.getElementById('file-size');
        
        fileName.textContent = file.name;
        fileSize.textContent = formatFileSize(file.size);
        filePreview.classList.remove('hidden');
    }
    
    function clearFileSelection() {
        document.getElementById('file-input').value = '';
        document.getElementById('file-preview').classList.add('hidden');
    }
    
    async function handleUpload(event) {
        event.preventDefault();
        
        const formData = new FormData(event.target);
        const file = formData.get('file');
        
        if (!file) {
            showError('Please select a file to upload');
            return;
        }
        
        const uploadBtn = document.getElementById('upload-btn');
        const uploadProgress = document.getElementById('upload-progress');
        
        try {
            uploadBtn.disabled = true;
            uploadProgress.classList.remove('hidden');
            
            // Simulate upload progress (in a real app, you'd track actual progress)
            let progress = 0;
            const progressInterval = setInterval(() => {
                progress += 10;
                document.getElementById('upload-percentage').textContent = progress + '%';
                document.getElementById('upload-progress-fill').style.width = progress + '%';
                
                if (progress >= 90) {
                    clearInterval(progressInterval);
                }
            }, 100);
            
            const response = await fetch('/api/v1/uploads/upload', {
                method: 'POST',
                body: formData
            });
            
            const result = await response.json();
            
            clearInterval(progressInterval);
            document.getElementById('upload-percentage').textContent = '100%';
            document.getElementById('upload-progress-fill').style.width = '100%';
            
            if (result.success) {
                showSuccess('Document uploaded successfully!');
                closeUploadModal();
                loadDocuments(); // Refresh the list
            } else {
                throw new Error(result.message || 'Upload failed');
            }
            
        } catch (error) {
            showError('Upload failed: ' + error.message);
        } finally {
            uploadBtn.disabled = false;
            uploadProgress.classList.add('hidden');
        }
    }
    
    // Document Actions
    async function viewDocument(documentId) {
        try {
            showLoading();
            const response = await apiCall(`/api/v1/uploads/documents/${documentId}`);
            hideLoading();
            
            // Populate modal with document details
            const detailsContainer = document.getElementById('document-details');
            detailsContainer.innerHTML = `
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <div>
                        <h3 class="text-lg font-semibold mb-4">Document Information</h3>
                        <div class="space-y-3">
                            <div>
                                <label class="block text-sm font-medium text-gray-500">Title</label>
                                <p class="text-gray-900">${escapeHtml(response.title)}</p>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-500">Category</label>
                                <p class="text-gray-900">${formatCategory(response.category)}</p>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-500">Status</label>
                                <span class="status-badge status-${response.status}">${formatStatus(response.status)}</span>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-500">Quality Score</label>
                                <p class="text-gray-900">${response.quality_score ? (response.quality_score * 100).toFixed(1) + '%' : 'Not calculated'}</p>
                            </div>
                        </div>
                    </div>
                    <div>
                        <h3 class="text-lg font-semibold mb-4">File Details</h3>
                        <div class="space-y-3">
                            <div>
                                <label class="block text-sm font-medium text-gray-500">Filename</label>
                                <p class="text-gray-900">${escapeHtml(response.original_filename)}</p>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-500">File Size</label>
                                <p class="text-gray-900">${formatFileSize(response.file_size)}</p>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-500">Uploaded</label>
                                <p class="text-gray-900">${formatDate(response.created_at)}</p>
                            </div>
                            ${response.uploaded_by ? `
                                <div>
                                    <label class="block text-sm font-medium text-gray-500">Uploaded By</label>
                                    <p class="text-gray-900">${escapeHtml(response.uploaded_by.full_name || response.uploaded_by.username)}</p>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                </div>
                
                ${response.description ? `
                    <div class="mt-6">
                        <h3 class="text-lg font-semibold mb-2">Description</h3>
                        <p class="text-gray-700">${escapeHtml(response.description)}</p>
                    </div>
                ` : ''}
                
                ${response.extracted_content ? `
                    <div class="mt-6">
                        <h3 class="text-lg font-semibold mb-2">Content Preview</h3>
                        <div class="bg-gray-50 p-4 rounded-lg max-h-64 overflow-y-auto">
                            <pre class="whitespace-pre-wrap text-sm text-gray-700">${escapeHtml(response.extracted_content.substring(0, 1000))}${response.extracted_content.length > 1000 ? '...' : ''}</pre>
                        </div>
                    </div>
                ` : ''}
                
                <div class="mt-6 flex justify-end space-x-3">
                    ${response.status === 'pending_approval' ? `
                        <button onclick="approveDocument(${response.id}); closeDetailModal();" class="btn-secondary">
                            <i class="fas fa-check mr-2"></i>Approve
                        </button>
                        <button onclick="rejectDocument(${response.id}); closeDetailModal();" class="btn-danger">
                            <i class="fas fa-times mr-2"></i>Reject
                        </button>
                    ` : ''}
                    <button onclick="closeDetailModal()" class="bg-gray-300 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-400">
                        Close
                    </button>
                </div>
            `;
            
            document.getElementById('detail-modal').classList.remove('hidden');
            document.body.style.overflow = 'hidden';
            
        } catch (error) {
            hideLoading();
            showError('Failed to load document details: ' + error.message);
        }
    }
    
    function closeDetailModal() {
        document.getElementById('detail-modal').classList.add('hidden');
        document.body.style.overflow = '';
    }
    
    async function approveDocument(documentId) {
        if (!confirm('Are you sure you want to approve this document?')) {
            return;
        }
        
        try {
            showLoading();
            await apiCall(`/api/v1/uploads/documents/${documentId}/approve`, {
                method: 'POST'
            });
            hideLoading();
            
            showSuccess('Document approved successfully');
            loadDocuments();
            
        } catch (error) {
            hideLoading();
            showError('Failed to approve document: ' + error.message);
        }
    }
    
    async function rejectDocument(documentId) {
        const reason = prompt('Please provide a reason for rejection:');
        if (!reason) return;
        
        try {
            showLoading();
            const formData = new FormData();
            formData.append('reason', reason);
            
            await fetch(`/api/v1/uploads/documents/${documentId}/reject`, {
                method: 'POST',
                body: formData
            });
            hideLoading();
            
            showSuccess('Document rejected');
            loadDocuments();
            
        } catch (error) {
            hideLoading();
            showError('Failed to reject document: ' + error.message);
        }
    }
    
    async function deleteDocument(documentId) {
        if (!confirm('Are you sure you want to delete this document? This action cannot be undone.')) {
            return;
        }
        
        try {
            showLoading();
            await apiCall(`/api/v1/uploads/documents/${documentId}`, {
                method: 'DELETE'
            });
            hideLoading();
            
            showSuccess('Document deleted successfully');
            loadDocuments();
            
        } catch (error) {
            hideLoading();
            showError('Failed to delete document: ' + error.message);
        }
    }
    
    // Selection and Bulk Actions
    function toggleSelectAll() {
        const selectAll = document.getElementById('select-all');
        const checkboxes = document.querySelectorAll('tbody input[type="checkbox"]');
        
        selectedDocuments.clear();
        
        checkboxes.forEach(checkbox => {
            checkbox.checked = selectAll.checked;
            if (selectAll.checked) {
                selectedDocuments.add(parseInt(checkbox.value));
            }
        });
        
        updateBulkActions();
    }
    
    function toggleDocumentSelection(documentId, checked) {
        if (checked) {
            selectedDocuments.add(documentId);
        } else {
            selectedDocuments.delete(documentId);
        }
        
        updateBulkActions();
        
        // Update select all checkbox
        const checkboxes = document.querySelectorAll('tbody input[type="checkbox"]');
        const checkedBoxes = document.querySelectorAll('tbody input[type="checkbox"]:checked');
        const selectAll = document.getElementById('select-all');
        
        if (checkedBoxes.length === 0) {
            selectAll.indeterminate = false;
            selectAll.checked = false;
        } else if (checkedBoxes.length === checkboxes.length) {
            selectAll.indeterminate = false;
            selectAll.checked = true;
        } else {
            selectAll.indeterminate = true;
            selectAll.checked = false;
        }
    }
    
    function updateBulkActions() {
        const bulkActions = document.getElementById('bulk-actions');
        const selectedCount = document.getElementById('selected-count');
        
        if (selectedDocuments.size > 0) {
            bulkActions.classList.remove('hidden');
            selectedCount.textContent = `${selectedDocuments.size} document${selectedDocuments.size > 1 ? 's' : ''} selected`;
        } else {
            bulkActions.classList.add('hidden');
        }
    }
    
    async function bulkApprove() {
        if (selectedDocuments.size === 0) return;
        
        if (!confirm(`Are you sure you want to approve ${selectedDocuments.size} document(s)?`)) {
            return;
        }
        
        try {
            showLoading();
            
            const promises = Array.from(selectedDocuments).map(id =>
                apiCall(`/api/v1/uploads/documents/${id}/approve`, { method: 'POST' })
            );
            
            await Promise.all(promises);
            hideLoading();
            
            showSuccess(`${selectedDocuments.size} document(s) approved successfully`);
            selectedDocuments.clear();
            loadDocuments();
            
        } catch (error) {
            hideLoading();
            showError('Failed to approve documents: ' + error.message);
        }
    }
    
    async function bulkReject() {
        if (selectedDocuments.size === 0) return;
        
        const reason = prompt('Please provide a reason for rejection:');
        if (!reason) return;
        
        try {
            showLoading();
            
            const promises = Array.from(selectedDocuments).map(id => {
                const formData = new FormData();
                formData.append('reason', reason);
                return fetch(`/api/v1/uploads/documents/${id}/reject`, {
                    method: 'POST',
                    body: formData
                });
            });
            
            await Promise.all(promises);
            hideLoading();
            
            showSuccess(`${selectedDocuments.size} document(s) rejected`);
            selectedDocuments.clear();
            loadDocuments();
            
        } catch (error) {
            hideLoading();
            showError('Failed to reject documents: ' + error.message);
        }
    }
    
    async function bulkDelete() {
        if (selectedDocuments.size === 0) return;
        
        if (!confirm(`Are you sure you want to delete ${selectedDocuments.size} document(s)? This action cannot be undone.`)) {
            return;
        }
        
        try {
            showLoading();
            
            const promises = Array.from(selectedDocuments).map(id =>
                apiCall(`/api/v1/uploads/documents/${id}`, { method: 'DELETE' })
            );
            
            await Promise.all(promises);
            hideLoading();
            
            showSuccess(`${selectedDocuments.size} document(s) deleted successfully`);
            selectedDocuments.clear();
            loadDocuments();
            
        } catch (error) {
            hideLoading();
            showError('Failed to delete documents: ' + error.message);
        }
    }
    
    function exportDocuments() {
        // This would generate and download a CSV/Excel export
        showSuccess('Export feature coming soon!');
    }
</script>
{% endblock %}

